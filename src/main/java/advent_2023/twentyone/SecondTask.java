package advent_2023.twentyone;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

public class SecondTask {

    public static void main(String[] args) {
        var input = """
                ...................................................................................................................................
                ..#......##................#......#.#............#.....#....#.................#.......#.....#.#.....##.....#.#........#.#..#....#..
                .......#....###...###.........##...#.#..#.....#......#...#................................................#.........##.#.#..#..###.
                ....#.....#..#.#.....#....#.#.##.#..........#...#.......................#...##......#...#.#.#....###.....#....#......#....#...#.#..
                ..##.#......##...##......#...#.#.#..##.#......#.........#............................#.........#...................#....#........#.
                .#..........#....#.....#.....#..#.....#........#...........................#..#.#........#....#.#.....#.#...#..................#...
                .#.#.#.#.#............#.....#.....#....#...........#.........................................#...#.......#....#....#.......#..#..#.
                .#......##.#.#..............#....#.....####....#..#.............................#............#..............###.#.....#............
                ..#........#.........#....#................##..................#..#........................#.#.#.......###..#...#...#..............
                .......#........#.......##.#..#.............................#.........................#........#........#.#.#..##..#..#.#......#...
                .....#.#.#.##....................#.#.#....##.#....#...............#..###.......#.............#......#....#...#..#...............#..
                .#..#...#.........#............#..#......#.#.....#...........#....#.....#..........#...........##......##.....#.#........#.........
                ........#.....#..#......#....#.#........##.#...........................#.......................##.....##..#........#.#......#.#....
                ..........#..#...............#..#..........#...#..........#.....#..#...#...........#..................#...................###..#.#.
                .#..#......#..#...#.#..#.....#.....###.........#...........#.#............#........#.....###.......##.....#.#.#...........#........
                .#.....#....##..##..#...........#.....#.......#.........#...#..............##..........#...#..#..#...#............#.#.#.......#....
                .#..#.#.#.......#....................#................#.#................#..............#..#..##..#.#..#..###....#.....#..#........
                ...#.....#.......##..#............##.....#..#..........#......##.......#..............#.#..#.......#.........#.....................
                ..#.#.....#.......#....#.........##................##....#...#.......................................#.......#.#..##......#...#....
                ...........#.#.#.....#...#.#..#....#..#..............#.#.#....#....##...................#....#......#........#....#..##...#...#....
                ....#........#....#.#..##...##...................#.....#........#....#...#.#.#.#.............#.....#.#.......##..#.#.......#....#..
                .##.#....#.......#.#......##.....#.#.#............#.......#........#...........................#.......##...#...##....#.........#..
                .......#....#................#..##.............###.....#.............#....#......##........#.##...................#................
                ....#.......##.................#...................##..#..............#.......##..##...........#..##...#.#.....#...###.....#.......
                .#.............................##................#......#...#...........#.#.#......#...........##.....##................#.#........
                .#.##.#........##.........#.....##.#...........#...........#.#....##.....##.......#...........#..#.......#.##......#.....#...#...#.
                ...#...##.......#.#...#.......#...#.................#......#..#...............#.#.#........................#...........#.....#.....
                .......#.#...#..##.........#.....#........#..##.#.#....#........#..##..........#...#..#..............#......##..#....#.......#.....
                ...##.......#..#......#...........................#..#.........#.............##........#.........#...#................#..###.......
                .........................##................#.#...##....#......#.#..#....#....#....#..#..........................#.#..#.......#.....
                ....#.....#...#.........#..#............##...#..#........#........##.#..#...........#..........................#...#.....#......#..
                .......................#..............#..#...#...............#..#.#..#..#...#...#.#..........................#.......#..#..........
                ....##.#.............#...#.................##....#......#....#.##........#...............##............##.#.................#...#..
                ...#...#..#...........#........................#....#.#.......#..........#.......##.......................##..#.#....#...........#.
                ..............#......##............#...##.#..........#....#....#.......#...................##..............#...#........#..#..#....
                .......#............##..#.#........#....#.##....#.....#.#.#.....#......#....#..........#...#...#..................#....##..........
                .............#....#...#..#..............#.......#........##...#...#..#....#...........##....#............#....#...#.#.#........#...
                .#.....###.#.....................#..........#.#.....#..#...#.#.#.....................#.............................................
                .#...#...........#.....#...........#....#....##.........#..#......#..#....#.....#....#.#...#..................##.........#..#....#.
                .#.......#......................##.........................#....#...#......##......#........#......#.........#.......##.#...#......
                ....##...........#...#.......#.......##........#................#.......#.#.##.............#..#.#................##.....#..#...##..
                ..........#.#.................#..#..#...##.###.......##.#..#........##......##..##...#...#..#..#####.#.........#..#...#.#..........
                ..#....#..#.#...............#...............#.#..####......#..........##.#...##...#.#................#................#.##..##..#..
                ..........#....##..........#..............#.......#.......#.#...#..##.....................#.#.#....#...#...........#...............
                ...#.......#.................#...........#..#........#...#..............#..............#....#...##....................#...#........
                ...####...#.............##.....#............#.##.....#...#..#.#......#.............#.........##....##...................#.#...#....
                ....#.....#.............#.....##...#..#...........#..#.....#......#.#.....#......#.....#....#......#...............................
                .....#...#..##.............#....##...#.......#...##......##.....#.......#...#........................#.#.......................#.#.
                .###.....#...#................#....#.....................###.#....#..#.#....................#....................................#.
                ...#..................#..#..#........##....#..#.#.##..#.#...#.........#..#.#...#...............#...........##..........##.#........
                ...........#..................#.............#...#.#.#......###..........#...#.......#.......#....#........#.#...........##.........
                .......#..#.......##..#............................##.....#.#..#.......##.....#...#.......#...........#....#...#...................
                ...#.............#.................#.#.###......##.........####.....#..##.............#.......##.....#....................#........
                .#................#.#..#..#..#..##.....#.......#..#.....#.......#....#.......#.............#.##......#.#.....#..............#..#...
                .....#.................#...#....#.#...#.#......#.#...........#............#...#..........................###...#.................#.
                ...........................#..#.#..#...#...............#...#...#....#...........##...........#...#..#.#........#..###........#.....
                ..................##....##......##.#........#..#...........#......#..............#........#...#..............#...#.#..........##...
                ...#...............#...###..#...........#.....#.......##.#...#..........##.....#........#.#.#..................##..#............#..
                ..#........#......#.....#.........#.......##......#..........#...........#..#.##....#...................#.##.......##..........##..
                ...............#...##....###.........#...#..............#.#.......#...#.....#.........##..#.......##..............#................
                ............#........#......##.#................##...#.....##...#.....##.......#..................#........#.##.#.....#.##.........
                ..........#....#....#...##..#.#..........#.............##..#......#.#......#.#..............#........#...#..#............##........
                ...........#.......##...#......#..#......#.#.......#.........#...........#.....#..##...#...##..............##........#.#..#........
                ............#....#.......#..........#..##..#...##...#.#.#.....#............#.#.......#.#..#........##......#....#.#.....#..........
                .......................#...........##.#..........#.....#.#.#..........#.#.............................#....##.....##......#..#.....
                .................................................................S.................................................................
                .....#.##.#..........#..#..#........#.#...#......#......#....#.#.....#.#..............................#.............#.....#........
                ......#.....#....#..#........#.....#.........#........#..#...#.......#.#.....##.....##....#..#.#..#.#..........#....#...#..........
                ...................##....#........#.#.........#.......#........................#.....#.#...#..###.......###..#...#.....##..........
                .........#.#...#.#.#.#......#............#....#.#........................#.......#.#.#........#..............#..#.#...#............
                ...............#..#.#...#..#......#....#....#.......##...............#.#.#..#......#...##.........................#................
                .#.....................#..#..#..............#....#...#...#....##....#.#...#.......##.#...........###...#.......#####...............
                ..#........#............#.#...#.......#...#...........#......#....#...........#..#..............#....#..#...##.......#..........##.
                .#.#.....................#..............#.#.........#.#...............#......#......#.#..##...#......#......#........##............
                ..............#....#.#....##.##.....#........#...............#..........................#...#....#.##.........#....................
                ..................##...............##..#....##..............#.....#...#........#.#...#...............###....#................#.###.
                .#...#............#.#.#..##....#......#........#.#........#.....#......#.......##.....#.#.#.....................#..................
                ...#.#.............#.............#.#.##...#.#.............................................#....##..#.#.....#..................#....
                ......#............#...#.......#.#..#......#.......#.....#.#.......#...##....##....##.............####...................#..#......
                .........#........#.....#..#...........#.#.......##.#..#....#..#.....#.#..#.#....#......#...................#.............#....#.#.
                ......#................#..................#............#.............#.....#.........#...##.....#.#.##..#..###.........##.......#..
                .............................#....#.....#.#............##....#..#......#..#.#....#.................#....#...#.........#............
                ....#.#.....................#........#.........##..............#...#..............................#....#.................#.......#.
                .#..#.................#..........#..#....#........##..#...............#......####.....#....#.....#..#....###........#.#.........#..
                ....##........#.........#...#..##.#.##....#......##........#......###..........#.#...#....#..#......................#........##....
                ........#.....#.#.........#......#.#........#....#..##....##................##.......#...#........#...........................#....
                .#...........#............#..........#.......#.##.......#.#........#...#..###...#..#......#.............#................##....##..
                ..................#..........##...##....##.#.....#.....####........##........#...#.........#...#.....#..#...........##......#..#.#.
                ...............#.....................#................#...#....#......................#.#.......#...............#.....#......#...#.
                ...#............#.............#.##...................#....#...#.....#...#...........#.#...#........#................##.....#.......
                ...........#........#..................#.#..#.#.....#...............#.....#.#........##.......#..#.#..........#.............#......
                ..#.....#....#.#.................#.#.........#.......##.....#.........#.....#...............#.#...##.......................#....#..
                ......###....#....#.#..#....................#....#....#..#........#...#.#...##........#..##........#............#.........#....#.#.
                ...#.#.....#....#......#.........#..##...#.##...#....#..##..#.#........#..##.#.................#...................................
                .........###.#...#...#...........................#.........#.#.##....#.#...#..........#..#.......#.........##.....#......#...#.#...
                .................#.....#..........#.#..#..###..................#........##....#.........#...................#....#.........#.....#.
                .#..#....#..#...#.....#............#.#..........#....#.#..#..##......................#..#..#......................#.............#..
                ..#..#.#...#..#.....#...............................#.........##......#.............#.##...............#..#.##.......##..#.......#.
                .....#...#.#....#...#..#..............#......#.#................#....#..#...........#.....#.#................#.##.........##.......
                ....#......##.........#.#...#.........#......#.##...##........#....#.................#......................###......#.....##......
                ...#.#.....#.....#.#.#.#...............#..#.....#.#...............#.#.........##.....##..#...................#.......#.#...........
                ..#.....#..#.....#...##....##..##.........#...#....#....#...#......##.##..#..#.........#............#..#.##...................#....
                ...#....###...#..........##......#........#..........#.............###.....#.....#..#.#...............#...##....#...##..#..#...#.#.
                ...#................#.........#................#..#..#..#.#...............#.....#...................#.................#...#........
                .#.......#.#.#.#.......#...................#...#......##.....#........##.....#...#........................#..#..#....#......#..#...
                ..##..#....#...#.......#........#...#....................###........##............#...............#....#.......#............#......
                .#............#.....#...##....#.......................#..#....#........#..........#..#...........#..#........................#.....
                ..........###....#..#.#..#..#.........#.......#...#......#....#...#.............#............#.....................#.#...#.......#.
                ...#..#..............................#.........#........##....##....##..##.....##......................#........#.....#...#...#.#..
                .#.#.................##.......#.#.#.....................#.....#........#......##.............#.......#..##....##........#.#.#......
                ...##.#.#..#...#........#......#.....#....................#........#.#.....#...#................#........#...#.##.....#..#.......#.
                .##.#.......#..#....#..#....#......#.....................#...........#......#.#..............#...#......#.#.......#......#.#.......
                ....#................###...#.......#...#..##........#...................#.......................#..##.......#................###...
                .........##.....#.....##..........#....#..##.............#.....##......##....#..................#..##.................#...#........
                .#..#....#....#.#........#..#................#............#.......#........#...................................##........#.......#.
                .........##...#........#.#............#.......#..........#.................#..........................#......##.....#....#.#....##.
                ...##......................#.....#....#.##...................#.............#..............#....#......#.............#........#.....
                ....#...........##.......#...#.....#.......#..#................#........##......................#..#....#..##.....#.#..............
                ......#..#...#......#.......#.....#.#..........#................#................#.....#.#.#....#...#..............................
                ....#....#..#...##..##.......#...................##..............................#........#................#....#..........#..#.#..
                ....#...##.....##...#......#.............#.......#..............................#..........#...............................#.#.....
                .##.#.....#..#.......#..##................#..#..##..#..........#..............#..#.#....#.#..#..##.#....#.##..#............#.....#.
                ....#..#.#............##.....##.............###.#............#.#.....#....................#.#........#....#.#..#..#...........#.#..
                .#.......#..................#...................#....#..........#...........#....#......#.........#.............##...............#.
                ..#...............##..#.#...###.....#...#....#....#...#........#..#....................##.#.......#...#.......#................#...
                ..#.##..........##......#...#.#.#.#.....##.....#.##..#..#.........#........#....................#.................#............##..
                ....#...##.......##....##...#.#..............#.....#......................#.#......#...................#..#.#...##.#..........#..#.
                .#.#....#..##..#..............###.......................###................#..#..#..##....#....#............##..#..................
                ......#..#......#.........#.#.#...#.......................##..............##...#.....##.#....#......#....#.........#.......#.....#.
                ....#.........#...............#...#............#.........#................##.#..........#.............#.......................#.##.
                ...................................................................................................................................
                """;

        var map = input
                .lines()
                .map(String::toCharArray)
                .toArray(char[][]::new);
        
        var rows = map.length;
        var cols = map[0].length;

        System.out.println("Rows = " + rows);
        System.out.println("Cols = " + cols);

        var startPoint = findStartPoint(map);

        var pointsToCheck = new ArrayList<Point>();
        var visited = new HashSet<Point>();

        pointsToCheck.add(startPoint);
        visited.add(startPoint);

        int currentStep = 0;
        long reached = 0;

        var firstLevelReached = new ArrayList<Long>();
        var secondLevelReached = new ArrayList<Long>();
        var thirdLevelReached = new ArrayList<Long>();

        while (true) {
            currentStep++;

            var nextPoints = new ArrayList<Point>();

            for (var point : pointsToCheck) {
                for (var newPoint : List.of(
                        new Point(point.row + 1, point.col),
                        new Point(point.row - 1, point.col),
                        new Point(point.row, point.col + 1),
                        new Point(point.row, point.col - 1))
                ) {
                    if (!visited.contains(newPoint)) {
                        var rowToCheck = ((newPoint.row % rows) + rows) % rows;
                        var colToCheck = ((newPoint.col % cols) + cols) % cols;

                        if (map[rowToCheck][colToCheck] != '#') {
                            nextPoints.add(newPoint);
                            visited.add(newPoint);
                        }
                    }
                }
            }

            if (currentStep % 2 == 1) {
                reached += nextPoints.size();

                if (currentStep % (2 * rows) == rows / 2) {
                    firstLevelReached.add(reached);

                    if (firstLevelReached.size() > 1){
                        secondLevelReached.add(
                                firstLevelReached.get(firstLevelReached.size() - 1) - firstLevelReached.get(firstLevelReached.size() - 2)
                        );
                    }

                    if (secondLevelReached.size() > 1) {
                        thirdLevelReached.add(
                                secondLevelReached.get(secondLevelReached.size() - 1) - secondLevelReached.get(secondLevelReached.size() - 2)
                        );
                    }
                    if (thirdLevelReached.size() > 1){
                        break;
                    }
                }
            }
            pointsToCheck = nextPoints;
        }

        var result = getResult(rows, currentStep, thirdLevelReached, secondLevelReached, reached);
        System.out.println(result);
    }

    private static Point findStartPoint(char[][] map) {
        for (int i = 0; i < map.length; i++) {
            for (int j = 0; j < map[0].length; j++) {
                if (map[j][i] == 'S') {
                    return new Point(i, j);
                }
            }
        }
        throw new RuntimeException("No start point found");
    }

    private static long getResult(int rows, int currentStep,
                                  ArrayList<Long> thirdLevelReached,
                                  ArrayList<Long> secondLevelReached,
                                  long reached) {
        long requiredLoops = 26501365 / (2L * rows) - 1;
        long doneLoops = currentStep / (2L * rows) - 1;
        long secondLevelLoop = requiredLoops - doneLoops;
        long thirdLevelLoop = (requiredLoops * (requiredLoops + 1))/2 - (doneLoops * (doneLoops + 1))/2;
        long thirdLevel = thirdLevelReached.get(thirdLevelReached.size() - 1);
        long secondLevel = secondLevelReached.get(0);

        return (thirdLevel * thirdLevelLoop + secondLevel * secondLevelLoop + reached);
    }

    record Point(int row, int col) {
    }
}
